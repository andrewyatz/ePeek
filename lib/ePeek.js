var epeek=function(){"use strict";var e,t,n,o,r,a,l,s,i,u,c,g="human",d=7,f=139424940,_=141784100,h="http://beta.rest.ensembl.org",p=h+"/feature/region/",m=h+"/lookup/",v=h+"/xrefs/symbol/",k=h+"/homology/id/",x=h+"/assembly/info/",P=[],b=300,y=600,w=150,D=d3.rgb("#DDDDDD"),j=d3.rgb("#000000"),I=d3.rgb("#000000"),O=!0,R=d3.ease("cubic-in-out"),S=d3.behavior.zoom(),E=500,T=function(e){c=d3.select(e).attr("id"),T.genes_layout.height(w),d3.select(e).classed("ePeek",!0);var t=d3.select(e),n=t.append("div").attr("class","ePeek_locRow"),o=t.append("div").attr("class","ePeek_groupDiv");a=o.append("svg").attr("class","ePeek_svg").attr("width",y).attr("height",w).style("background-color",D).append("g").attr("transform","translate(0,20)").append("g").attr("class","ePeek_g"),l=a.append("rect").attr("class","ePeek_pane").attr("id","ePeek_"+c+"_pane").attr("width",y).attr("height",w).style("fill",j);var r=a.append("text").attr("class","ePeek_wideOK_text").attr("id","ePeek_"+c+"_tooWide").attr("fill",D).text("Region too wide"),s=r[0][0].getBBox();r.attr("x",~~(y/2-s.width/2)).attr("y",~~(w/2-s.height/2)),n.append("span").text("Current location: "),n.append("span").attr("id","ePeek_"+c+"_species").text(g),n.append("span").text(" ("),n.append("span").attr("id","ePeek_"+c+"_chr").text(d),n.append("span").text(":"),n.append("span").attr("id","ePeek_"+c+"_from").text(f),n.append("span").text("-"),n.append("span").attr("id","ePeek_"+c+"_to").text(_),n.append("span").text(")")};T.startOnOrigin=function(){void 0!==T.gene()?T.get_gene(T.gene()):T.start()},T.start=function(){var e=B();console.log("URL: "),console.log(e),U(),d3.json(e,function(e,t){console.log("RESP: "),console.log(t),P=t,z(),A()})};var z=function(){s=d3.scale.linear().domain([f,_]).range([0,y]),T.genes_layout(P,s),i=d3.svg.axis().scale(s).orient("top"),O&&l.call(S.x(s).on("zoom",N))},A=function(){var e=T.genes_layout.genes(),t=a.selectAll(".ePeek_gs").data(e,function(e){return e.ID});t.selectAll(".ePeek_gene").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot}).attr("height",T.genes_layout.gene_slot().gene_height),t.selectAll(".ePeek_name").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}),t.enter().append("g").attr("class","ePeek_gs").call(G),t.exit().remove(),t.on("click",function(e){T.gene_info_callback(e)}),L()},G=function(e){e.append("rect").attr("class","ePeek_gene").attr("x",function(e){return s(e.start)}).attr("y",function(e){return console.log("D.SLOT:"+e.slot),console.log("SLOT_HEIGHT:"+T.genes_layout.gene_slot().slot_height),T.genes_layout.gene_slot().slot_height*e.slot}).attr("width",function(e){return s(e.end)-s(e.start)}).attr("height",T.genes_layout.gene_slot().gene_height).attr("fill",D).transition().duration(E).attr("fill",function(){return j}),e.append("text").attr("class","ePeek_name").attr("x",function(e){return s(e.start)}).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).attr("fill",D).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}).style("font-weight",function(){return"normal"}).transition().duration(E).attr("fill",function(){return j})},L=function(){a.call(i);var e=a.selectAll(".ePeek_gs");e.select(".ePeek_gene").attr("x",function(e){return s(e.start)}).attr("width",function(e){return s(e.end)-s(e.start)}),e.select(".ePeek_name").attr("x",function(e){return s(e.start)});var t=s.domain();d3.select("#ePeek_"+c+"_species").text(g),d3.select("#ePeek_"+c+"_chr").text(d),d3.select("#ePeek_"+c+"_from").text(~~t[0]),d3.select("#ePeek_"+c+"_to").text(~~t[1])},W=function(e,t){var n,o=s.domain(),r=o[1]-o[0],a=r*e-r;switch(t){case-1:n=[~~o[0]-a,~~(o[1]-a)];break;case 1:n=[~~o[0]+a,~~(o[1]-a)];break;case 0:n=[o[0]-~~(a/2),o[1]+~~a/2]}var l=d3.interpolateNumber(o[0],n[0]),i=T.ease(),u=0;d3.timer(function(){var e,n=l(i(u));switch(t){case-1:e=n+r;break;case 1:e=n+r;break;case 0:e=o[1]+o[0]-n}var a=[n,e];return s.domain(a),N(s),u+=.02,u>1})};T.right=function(e){e>0&&W(e,1)},T.left=function(e){e>0&&W(e,-1)},T.zoom=function(e){W(e,0)};var N=function(e){void 0!==e&&O&&S.x(e);var t=s.domain();t[0]<0?(void 0===o&&(o=t[1]),t=[0,o],s.domain(t),O&&S.x(s)):o=void 0,t[1]>n?(void 0===r&&(r=t[0]),s.domain([r,n]),O&&S.x(s)):r=void 0,window.clearTimeout(u),u=window.setTimeout(function(){var e=s.domain();T.from(~~e[0]),T.to(~~e[1]),console.log("New Pos:"+f+"-"+_);var t=B();console.log(t),d3.json(t,function(e,t){null!==e?(d3.select("#ePeek_"+c+"_pane").classed("ePeek_dark_pane",!0),d3.select("#ePeek_"+c+"_tooWide").classed("ePeek_tooWide_text",!0).moveToFront()):(d3.select("#ePeek_"+c+"_pane").classed("ePeek_dark_pane",!1),d3.select("#ePeek_"+c+"_tooWide").classed("ePeek_tooWide_text",!1),T.genes_layout(t,s),A())})},300),L()},H=function(e,t){e.select(".ePeek_gene").transition().duration(500).attr("fill",t),e.select(".ePeek_name").transition().duration(500).style("fill",t)};T.unhighlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return H(t,j),T},T.highlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return H(t,I),T},T.resize=function(e){d3.select(".ePeek_svg").attr("width",e),d3.select("#ePeek_"+c+"_pane").attr("width",e),T.width(e),z(),L()},T.get_gene=function(e){var t=v+g+"/"+e+".json?object=gene";console.log("URL: "+t),d3.json(t,function(e,t){t=t.filter(function(e){return!e.id.indexOf("ENS")}),console.log("RESP:"),console.log(t),void 0!==t[0]?(q(t[0].id),T.ensGenes_callback(t),T.ensGene_lookup(t[0].id)):T.start()})},T.homologues=function(e){var t=k+e+".json?format=condensed;sequence=none;type=all";console.log(t),d3.json(t,function(e,t){console.log("HOMOLOGUES RESP: "),console.log(t),void 0!==t&&T.homologues_callback(t.data[0].homologies)})},T.ensGene_lookup=function(e){T.homologues(e);var t=m+e+".json?format=full";console.log("lookup url:"),console.log(t),d3.json(t,function(e,t){console.log("RESP:"),console.log(t),T.species(t.species).chr(t.seq_region_name).from(t.start).to(t.end),T.start()})};var U=function(){var e=x+g+"/"+d;d3.json(e,function(e,t){n=t.length})},q=function(e){return arguments.length?(t=e,T):t};T.species=function(e){return arguments.length?(g=e,T):g},T.chr=function(e){return arguments.length?(d=e,T):d},T.from=function(e){return arguments.length?(f=e,T):f},T.to=function(e){return arguments.length?(_=e,T):_},T.gene=function(t){return arguments.length?(e=t,T):e},T.height=function(e){return arguments.length?(w=e,T):w},T.width=function(e){return arguments.length?(b>e&&(e=b),y=e,T):y},T.background_color=function(e){return arguments.length?(D=d3.rgb(e),T):D},T.foreground_color=function(e){return arguments.length?(j=d3.rgb(e),T):j},T.highlight_color=function(e){return arguments.length?(I=d3.rgb(e),T):I},T.localREST=function(){return h="http://127.0.0.1:3000",p=h+"/feature/region/",m=h+"/lookup/id/",v=h+"/xrefs/symbol/",k=h+"/homology/id/",T},T.ease=function(e){return arguments.length?(R=d3.ease(e),T):R},T.allow_drag=function(e){return arguments.length?(O=e,O?void 0!==s&&(l.call(S.x(s).on("zoom",N)),S.x(s).on("zoom",N)):S.x(d3.scale.linear()).on("zoom",null),T):O};var B=function(){var e=p+g+"/"+d+":"+f+"-"+_+".json?feature=gene";return e};return T.split_homologues=function(e){var t=/ortholog/,n=/paralog/,o=e.filter(function(e){return e.type.match(t)}),r=e.filter(function(e){return e.type.match(n)});return{orthologues:o,paralogues:r}},T.genes_layout=epeek_genes(),T.gene_info_callback=function(){},T.ensGenes_callback=function(){},T.homologues_callback=function(){},T};d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var epeek_genes=function(){"use strict";var e,t,n=150,o=[],r={expanded:{slot_height:30,gene_height:10,show_label:!0},collapsed:{slot_height:5,gene_height:3,show_label:!1}},a="expanded",l=function(e,i){for(var c=0;c<e.length;c++)null===e[c].external_name&&(e[c].external_name="");t=~~(n/r.expanded.slot_height)-1,void 0!==i&&l.scale(i),u(e,o);var d=s(e);d>t?(a="collapsed",g(n,d)):a="expanded",o=e};l.genes=function(){return o},l.gene_slot=function(){return r[a]},l.height=function(e){return arguments.length?(n=e,l):n},l.scale=function(t){return arguments.length?(e=t,l):e};var s=function(e){for(var n=[],o=e,r=0,a=0;a<e.length;a++)e[a].slot>r&&e[a].slot<t&&(r=e[a].slot);for(var a=0;a<o.length;a++){var l=d(n),s=o[a];if(void 0!==s.slot&&s.slot<t&&i(s,l[s.slot]))n.push(s);else for(var u=0;;){if(i(s,l[u])){s.slot=u,n.push(s),u>r&&(r=u);break}u++}}return r+1},i=function(t,n){if(void 0===n)return!0;for(var o=0;o<n.length;o++){var r=n[o];if(t.ID!==r.ID){var a=8*r.external_name.length+e(r.start),l=e(r.start),s=e(r.end)>a?e(r.end):a,i=8*t.external_name.length+e(t.start),u=e(t.start),c=e(t.end)>i?e(t.end):i;if(l>u&&c>l||u>l&&s>u)return!1}}return!0},u=function(e,t){for(var n=c(t),o=0;o<e.length;o++)void 0!==n[e[o].ID]&&(e[o].slot=n[e[o].ID])},c=function(e){for(var t={},n=0;n<e.length;n++){var o=e[n];t[o.ID]=o.slot}return t},g=function(){},d=function(e){for(var t=[],n=0;n<e.length;n++)void 0===t[e[n].slot]&&(t[e[n].slot]=[]),t[e[n].slot].push(e[n]);return t};return l};