var epeek=function(){"use strict";var e,t,n,r,o,a,s,l,i,c,u,g="human",_=7,d=139424940,f=141784100,h=rest(),p=scriptPath("ePeek.js"),m=[],v=300,k=600,P=150,x=d3.rgb("#DDDDDD"),y=d3.rgb("#000000"),b=d3.rgb("#000000"),w=!0,D=d3.ease("cubic-in-out"),I=d3.behavior.zoom(),E=500,T=function(e){u=d3.select(e).attr("id"),T.genes_layout.height(P),d3.select(e).classed("ePeek",!0);var t=d3.select(e),n=t.append("div").attr("class","ePeek_locRow"),r=t.append("div").attr("class","ePeek_groupDiv");a=r.append("svg").attr("class","ePeek_svg").attr("width",k).attr("height",P).style("background-color",x).append("g").attr("transform","translate(0,20)").append("g").attr("class","ePeek_g"),s=a.append("rect").attr("class","ePeek_pane").attr("id","ePeek_"+u+"_pane").attr("width",k).attr("height",P).style("fill",y);var o=a.append("text").attr("class","ePeek_wideOK_text").attr("id","ePeek_"+u+"_tooWide").attr("fill",x).text("Region too wide"),l=o[0][0].getBBox();o.attr("x",~~(k/2-l.width/2)).attr("y",~~(P/2-l.height/2)),n.append("span").text("Current location: "),n.append("span").attr("id","ePeek_"+u+"_species").text(g),n.append("span").text(" ("),n.append("span").attr("id","ePeek_"+u+"_chr").text(_),n.append("span").text(":"),n.append("span").attr("id","ePeek_"+u+"_from").text(d),n.append("span").text("-"),n.append("span").attr("id","ePeek_"+u+"_to").text(f),n.append("span").text(")"),n.append("img").attr("class","ePeek_activity_signal").attr("id","ePeek_"+u+"_activity_signal").attr("src",p+"green_button_small.png").style("position","absolute").style("left",k-10+"px")};T.startOnOrigin=function(){void 0!==T.gene()?T.get_gene(T.gene()):T.start()},T.start=function(){h.call({url:h.url("chr_info",{species:g,chr:_}),success:function(e){n=e.length}}),h.call({url:h.url("region",{species:g,chr:_,fromPos:d,toPos:f}),success:function(e){m=e,A(),R()}})};var A=function(){l=d3.scale.linear().domain([d,f]).range([0,k]),T.genes_layout(m,l),i=d3.svg.axis().scale(l).orient("top"),w&&s.call(I.x(l).on("zoom",N))},R=function(){var e=T.genes_layout.genes(),t=a.selectAll(".ePeek_gs").data(e,function(e){return e.ID});t.selectAll(".ePeek_gene").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot}).attr("height",T.genes_layout.gene_slot().gene_height),t.selectAll(".ePeek_name").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}),t.enter().append("g").attr("class","ePeek_gs").call(j),t.exit().remove(),t.on("click",function(e){T.gene_info_callback(e)}),z()},j=function(e){e.append("rect").attr("class","ePeek_gene").attr("x",function(e){return l(e.start)}).attr("y",function(e){return console.log("D.SLOT:"+e.slot),console.log("SLOT_HEIGHT:"+T.genes_layout.gene_slot().slot_height),T.genes_layout.gene_slot().slot_height*e.slot}).attr("width",function(e){return l(e.end)-l(e.start)}).attr("height",T.genes_layout.gene_slot().gene_height).attr("fill",x).transition().duration(E).attr("fill",function(){return y}),e.append("text").attr("class","ePeek_name").attr("x",function(e){return l(e.start)}).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).attr("fill",x).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}).style("font-weight",function(){return"normal"}).transition().duration(E).attr("fill",function(){return y})},z=function(){a.call(i);var e=a.selectAll(".ePeek_gs");e.select(".ePeek_gene").attr("x",function(e){return l(e.start)}).attr("width",function(e){return l(e.end)-l(e.start)}),e.select(".ePeek_name").attr("x",function(e){return l(e.start)});var t=l.domain();d3.select("#ePeek_"+u+"_species").text(g),d3.select("#ePeek_"+u+"_chr").text(_),d3.select("#ePeek_"+u+"_from").text(~~t[0]),d3.select("#ePeek_"+u+"_to").text(~~t[1])},G=function(e,t){var n,r=l.domain(),o=r[1]-r[0],a=o*e-o;switch(t){case-1:n=[~~r[0]-a,~~(r[1]-a)];break;case 1:n=[~~r[0]+a,~~(r[1]-a)];break;case 0:n=[r[0]-~~(a/2),r[1]+~~a/2]}var s=d3.interpolateNumber(r[0],n[0]),i=T.ease(),c=0;d3.timer(function(){var e,n=s(i(c));switch(t){case-1:e=n+o;break;case 1:e=n+o;break;case 0:e=r[1]+r[0]-n}var a=[n,e];return l.domain(a),N(l),c+=.02,c>1})};T.right=function(e){e>0&&G(e,1)},T.left=function(e){e>0&&G(e,-1)},T.zoom=function(e){G(e,0)};var N=function(e){void 0!==e&&w&&I.x(e);var t=l.domain();t[0]<0?(void 0===r&&(r=t[1]),t=[0,r],l.domain(t),w&&I.x(l)):r=void 0,t[1]>n?(void 0===o&&(o=t[0]),l.domain([o,n]),w&&I.x(l)):o=void 0,window.clearTimeout(c),c=window.setTimeout(function(){var e=l.domain();T.from(~~e[0]),T.to(~~e[1]),console.log("New Pos:"+d+"-"+f),d3.select("#ePeek_"+u+"_activity_signal").attr("src",p+"red_button_small.png"),h.call({url:h.url("region",{species:g,chr:_,fromPos:d,toPos:f}),success:function(e){d3.select("#ePeek_"+u+"_activity_signal").attr("src",p+"green_button_small.png"),d3.select("#ePeek_"+u+"_pane").classed("ePeek_dark_pane",!1),d3.select("#ePeek_"+u+"_tooWide").classed("ePeek_tooWide_text",!1),T.genes_layout(e,l),R()},error:function(){console.log("GREEN AGAIN!!!"),d3.select("#ePeek_"+u+"_activity_signal").attr("src","lib/green_button_small.png"),d3.select("#ePeek_"+u+"_pane").classed("ePeek_dark_pane",!0),d3.select("#ePeek_"+u+"_tooWide").classed("ePeek_tooWide_text",!0).moveToFront()}})},300),z()},O=function(e,t){e.select(".ePeek_gene").transition().duration(500).attr("fill",t),e.select(".ePeek_name").transition().duration(500).style("fill",t)};T.unhighlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return O(t,y),T},T.highlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return O(t,b),T},T.resize=function(e){d3.select(".ePeek_svg").attr("width",e),d3.select("#ePeek_"+u+"_pane").attr("width",e),T.width(e),A(),z()},T.get_gene=function(e){h.call({url:h.url("species_gene",{species:g,gene_name:e}),success:function(e){e=e.filter(function(e){return!e.id.indexOf("ENS")}),void 0!==e[0]?(S(e[0].id),T.ensGenes_callback(e),T.ensGene_lookup(e[0].id)):T.start()}})},T.homologues=function(e){h.call({url:h.url("homologues",{gene_name:e}),success:function(e){var t=e.data[0].homologies;T.homologues_callback(t)}})},T.ensGene_lookup=function(e){T.homologues(e),h.call({url:h.url("gene",{gene_name:e}),success:function(e){T.species(e.species).chr(e.seq_region_name).from(e.start).to(e.end),T.start()}})};var S=function(e){return arguments.length?(t=e,T):t};return T.species=function(e){return arguments.length?(g=e,T):g},T.chr=function(e){return arguments.length?(_=e,T):_},T.from=function(e){return arguments.length?(d=e,T):d},T.to=function(e){return arguments.length?(f=e,T):f},T.gene=function(t){return arguments.length?(e=t,T):e},T.height=function(e){return arguments.length?(P=e,T):P},T.width=function(e){return arguments.length?(v>e&&(e=v),k=e,T):k},T.background_color=function(e){return arguments.length?(x=d3.rgb(e),T):x},T.foreground_color=function(e){return arguments.length?(y=d3.rgb(e),T):y},T.highlight_color=function(e){return arguments.length?(b=d3.rgb(e),T):b},T.ease=function(e){return arguments.length?(D=d3.ease(e),T):D},T.allow_drag=function(e){return arguments.length?(w=e,w?void 0!==l&&(s.call(I.x(l).on("zoom",N)),I.x(l).on("zoom",N)):I.x(d3.scale.linear()).on("zoom",null),T):w},T.split_homologues=function(e){var t=/ortholog/,n=/paralog/,r=e.filter(function(e){return e.type.match(t)}),o=e.filter(function(e){return e.type.match(n)});return{orthologues:r,paralogues:o}},T.genes_layout=epeek_genes(),T.gene_info_callback=function(){},T.ensGenes_callback=function(){},T.homologues_callback=function(){},T};d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var rest=function(){var e="http://beta.rest.ensembl.org",t=e+"/feature/region/",n=e+"/lookup/",r=e+"/xrefs/symbol/",o=e+"/homology/id/",a=e+"/assembly/info/",s=function(){};return s.localREST=function(){return e="http://127.0.0.1:3000",t=e+"/feature/region/",n=e+"/lookup/id/",r=e+"/xrefs/symbol/",o=e+"/homology/id/",s},s.call=function(e){var t=e.url,n=e.success,r=e.error;console.log("URL:"+t),d3.json(t,function(e,t){console.log("RESP:"),console.log(t),void 0!==t&&null===e&&n(t),null!==e&&r()})},s.url=function(e,s){return"region"===e?t+s.species+"/"+s.chr+":"+s.fromPos+"-"+s.toPos+".json?feature=gene":"species_gene"===e?r+s.species+"/"+s.gene_name+".json?object_type=gene":"homologues"===e?o+s.gene_name+".json?format=condensed;sequence=none;type=all":"gene"===e?n+s.gene_name+".json?format=full":"chr_info"===e?a+s.species+"/"+s.chr:void 0},s},epeek_genes=function(){"use strict";var e,t,n=150,r=[],o={expanded:{slot_height:30,gene_height:10,show_label:!0},collapsed:{slot_height:5,gene_height:3,show_label:!1}},a="expanded",s=function(e,i){for(var u=0;u<e.length;u++)null===e[u].external_name&&(e[u].external_name="");t=~~(n/o.expanded.slot_height)-1,void 0!==i&&s.scale(i),c(e,r);var _=l(e);_>t?(a="collapsed",g(n,_)):a="expanded",r=e};s.genes=function(){return r},s.gene_slot=function(){return o[a]},s.height=function(e){return arguments.length?(n=e,s):n},s.scale=function(t){return arguments.length?(e=t,s):e};var l=function(e){for(var n=[],r=e,o=0,a=0;a<e.length;a++)e[a].slot>o&&e[a].slot<t&&(o=e[a].slot);for(var a=0;a<r.length;a++){var s=_(n),l=r[a];if(void 0!==l.slot&&l.slot<t&&i(l,s[l.slot]))n.push(l);else for(var c=0;;){if(i(l,s[c])){l.slot=c,n.push(l),c>o&&(o=c);break}c++}}return o+1},i=function(t,n){if(void 0===n)return!0;for(var r=0;r<n.length;r++){var o=n[r];if(t.ID!==o.ID){var a=8*o.external_name.length+e(o.start),s=e(o.start),l=e(o.end)>a?e(o.end):a,i=8*t.external_name.length+e(t.start),c=e(t.start),u=e(t.end)>i?e(t.end):i;if(s>c&&u>s||c>s&&l>c)return!1}}return!0},c=function(e,t){for(var n=u(t),r=0;r<e.length;r++)void 0!==n[e[r].ID]&&(e[r].slot=n[e[r].ID])},u=function(e){for(var t={},n=0;n<e.length;n++){var r=e[n];t[r.ID]=r.slot}return t},g=function(){},_=function(e){for(var t=[],n=0;n<e.length;n++)void 0===t[e[n].slot]&&(t[e[n].slot]=[]),t[e[n].slot].push(e[n]);return t};return s},scriptPath=function(e){var t=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),n=new RegExp(t+"$"),r=new RegExp("(.*)"+t+"$"),o=document.getElementsByTagName("script"),a="";if(void 0!==o)for(var s in o)if(o[s].src&&o[s].src.match(n))return o[s].src.replace(r,"$1");return a};