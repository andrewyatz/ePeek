var epeek=function(){"use strict";var e,t,n,o,r,a,s,l,i,u,c,g="human",d=7,f=139424940,_=141784100,h=rest(),p=[],m=300,v=600,k=150,x=d3.rgb("#DDDDDD"),P=d3.rgb("#000000"),y=d3.rgb("#000000"),b=!0,w=d3.ease("cubic-in-out"),D=d3.behavior.zoom(),I=500,T=function(e){c=d3.select(e).attr("id"),T.genes_layout.height(k),d3.select(e).classed("ePeek",!0);var t=d3.select(e),n=t.append("div").attr("class","ePeek_locRow"),o=t.append("div").attr("class","ePeek_groupDiv");a=o.append("svg").attr("class","ePeek_svg").attr("width",v).attr("height",k).style("background-color",x).append("g").attr("transform","translate(0,20)").append("g").attr("class","ePeek_g"),s=a.append("rect").attr("class","ePeek_pane").attr("id","ePeek_"+c+"_pane").attr("width",v).attr("height",k).style("fill",P);var r=a.append("text").attr("class","ePeek_wideOK_text").attr("id","ePeek_"+c+"_tooWide").attr("fill",x).text("Region too wide"),l=r[0][0].getBBox();r.attr("x",~~(v/2-l.width/2)).attr("y",~~(k/2-l.height/2)),n.append("span").text("Current location: "),n.append("span").attr("id","ePeek_"+c+"_species").text(g),n.append("span").text(" ("),n.append("span").attr("id","ePeek_"+c+"_chr").text(d),n.append("span").text(":"),n.append("span").attr("id","ePeek_"+c+"_from").text(f),n.append("span").text("-"),n.append("span").attr("id","ePeek_"+c+"_to").text(_),n.append("span").text(")")};T.startOnOrigin=function(){void 0!==T.gene()?T.get_gene(T.gene()):T.start()},T.start=function(){h.call({url:h.url("chr_info",{species:g,chr:d}),success:function(e){n=e.length}}),h.call({url:h.url("region",{species:g,chr:d,fromPos:f,toPos:_}),success:function(e){p=e,z(),j()}})};var z=function(){l=d3.scale.linear().domain([f,_]).range([0,v]),T.genes_layout(p,l),i=d3.svg.axis().scale(l).orient("top"),b&&s.call(D.x(l).on("zoom",R))},j=function(){var e=T.genes_layout.genes(),t=a.selectAll(".ePeek_gs").data(e,function(e){return e.ID});t.selectAll(".ePeek_gene").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot}).attr("height",T.genes_layout.gene_slot().gene_height),t.selectAll(".ePeek_name").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}),t.enter().append("g").attr("class","ePeek_gs").call(A),t.exit().remove(),t.on("click",function(e){T.gene_info_callback(e)}),O()},A=function(e){e.append("rect").attr("class","ePeek_gene").attr("x",function(e){return l(e.start)}).attr("y",function(e){return console.log("D.SLOT:"+e.slot),console.log("SLOT_HEIGHT:"+T.genes_layout.gene_slot().slot_height),T.genes_layout.gene_slot().slot_height*e.slot}).attr("width",function(e){return l(e.end)-l(e.start)}).attr("height",T.genes_layout.gene_slot().gene_height).attr("fill",x).transition().duration(I).attr("fill",function(){return P}),e.append("text").attr("class","ePeek_name").attr("x",function(e){return l(e.start)}).attr("y",function(e){return T.genes_layout.gene_slot().slot_height*e.slot+25}).attr("fill",x).text(function(e){return T.genes_layout.gene_slot().show_label?e.external_name:""}).style("font-weight",function(){return"normal"}).transition().duration(I).attr("fill",function(){return P})},O=function(){a.call(i);var e=a.selectAll(".ePeek_gs");e.select(".ePeek_gene").attr("x",function(e){return l(e.start)}).attr("width",function(e){return l(e.end)-l(e.start)}),e.select(".ePeek_name").attr("x",function(e){return l(e.start)});var t=l.domain();d3.select("#ePeek_"+c+"_species").text(g),d3.select("#ePeek_"+c+"_chr").text(d),d3.select("#ePeek_"+c+"_from").text(~~t[0]),d3.select("#ePeek_"+c+"_to").text(~~t[1])},G=function(e,t){var n,o=l.domain(),r=o[1]-o[0],a=r*e-r;switch(t){case-1:n=[~~o[0]-a,~~(o[1]-a)];break;case 1:n=[~~o[0]+a,~~(o[1]-a)];break;case 0:n=[o[0]-~~(a/2),o[1]+~~a/2]}var s=d3.interpolateNumber(o[0],n[0]),i=T.ease(),u=0;d3.timer(function(){var e,n=s(i(u));switch(t){case-1:e=n+r;break;case 1:e=n+r;break;case 0:e=o[1]+o[0]-n}var a=[n,e];return l.domain(a),R(l),u+=.02,u>1})};T.right=function(e){e>0&&G(e,1)},T.left=function(e){e>0&&G(e,-1)},T.zoom=function(e){G(e,0)};var R=function(e){void 0!==e&&b&&D.x(e);var t=l.domain();t[0]<0?(void 0===o&&(o=t[1]),t=[0,o],l.domain(t),b&&D.x(l)):o=void 0,t[1]>n?(void 0===r&&(r=t[0]),l.domain([r,n]),b&&D.x(l)):r=void 0,window.clearTimeout(u),u=window.setTimeout(function(){var e=l.domain();T.from(~~e[0]),T.to(~~e[1]),console.log("New Pos:"+f+"-"+_),h.call({url:h.url("region",{species:g,chr:d,fromPos:f,toPos:_}),success:function(e){d3.select("#ePeek_"+c+"_pane").classed("ePeek_dark_pane",!1),d3.select("#ePeek_"+c+"_tooWide").classed("ePeek_tooWide_text",!1),T.genes_layout(e,l),j()},error:function(){d3.select("#ePeek_"+c+"_pane").classed("ePeek_dark_pane",!0),d3.select("#ePeek_"+c+"_tooWide").classed("ePeek_tooWide_text",!0).moveToFront()}})},300),O()},S=function(e,t){e.select(".ePeek_gene").transition().duration(500).attr("fill",t),e.select(".ePeek_name").transition().duration(500).style("fill",t)};T.unhighlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return S(t,P),T},T.highlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return S(t,y),T},T.resize=function(e){d3.select(".ePeek_svg").attr("width",e),d3.select("#ePeek_"+c+"_pane").attr("width",e),T.width(e),z(),O()},T.get_gene=function(e){h.call({url:h.url("species_gene",{species:g,gene_name:e}),success:function(e){e=e.filter(function(e){return!e.id.indexOf("ENS")}),void 0!==e[0]?(W(e[0].id),T.ensGenes_callback(e),T.ensGene_lookup(e[0].id)):T.start()}})},T.homologues=function(e){h.call({url:h.url("homologues",{gene_name:e}),success:function(e){var t=e.data[0].homologies;T.homologues_callback(t)}})},T.ensGene_lookup=function(e){T.homologues(e),h.call({url:h.url("gene",{gene_name:e}),success:function(e){T.species(e.species).chr(e.seq_region_name).from(e.start).to(e.end),T.start()}})};var W=function(e){return arguments.length?(t=e,T):t};return T.species=function(e){return arguments.length?(g=e,T):g},T.chr=function(e){return arguments.length?(d=e,T):d},T.from=function(e){return arguments.length?(f=e,T):f},T.to=function(e){return arguments.length?(_=e,T):_},T.gene=function(t){return arguments.length?(e=t,T):e},T.height=function(e){return arguments.length?(k=e,T):k},T.width=function(e){return arguments.length?(m>e&&(e=m),v=e,T):v},T.background_color=function(e){return arguments.length?(x=d3.rgb(e),T):x},T.foreground_color=function(e){return arguments.length?(P=d3.rgb(e),T):P},T.highlight_color=function(e){return arguments.length?(y=d3.rgb(e),T):y},T.ease=function(e){return arguments.length?(w=d3.ease(e),T):w},T.allow_drag=function(e){return arguments.length?(b=e,b?void 0!==l&&(s.call(D.x(l).on("zoom",R)),D.x(l).on("zoom",R)):D.x(d3.scale.linear()).on("zoom",null),T):b},T.split_homologues=function(e){var t=/ortholog/,n=/paralog/,o=e.filter(function(e){return e.type.match(t)}),r=e.filter(function(e){return e.type.match(n)});return{orthologues:o,paralogues:r}},T.genes_layout=epeek_genes(),T.gene_info_callback=function(){},T.ensGenes_callback=function(){},T.homologues_callback=function(){},T};d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var rest=function(){var e="http://beta.rest.ensembl.org",t=e+"/feature/region/",n=e+"/lookup/",o=e+"/xrefs/symbol/",r=e+"/homology/id/",a=e+"/assembly/info/",s=function(){};return s.localREST=function(){return e="http://127.0.0.1:3000",t=e+"/feature/region/",n=e+"/lookup/id/",o=e+"/xrefs/symbol/",r=e+"/homology/id/",s},s.call=function(e){var t=e.url,n=e.success,o=e.error;console.log("URL:"+t),d3.json(t,function(e,t){console.log("RESP:"),console.log(t),void 0!==t&&null===e&&n(t),null!==e&&o()})},s.url=function(e,s){return"region"===e?t+s.species+"/"+s.chr+":"+s.fromPos+"-"+s.toPos+".json?feature=gene":"species_gene"===e?o+s.species+"/"+s.gene_name+".json?object_type=gene":"homologues"===e?r+s.gene_name+".json?format=condensed;sequence=none;type=all":"gene"===e?n+s.gene_name+".json?format=full":"chr_info"===e?a+s.species+"/"+s.chr:void 0},s},epeek_genes=function(){"use strict";var e,t,n=150,o=[],r={expanded:{slot_height:30,gene_height:10,show_label:!0},collapsed:{slot_height:5,gene_height:3,show_label:!1}},a="expanded",s=function(e,i){for(var c=0;c<e.length;c++)null===e[c].external_name&&(e[c].external_name="");t=~~(n/r.expanded.slot_height)-1,void 0!==i&&s.scale(i),u(e,o);var d=l(e);d>t?(a="collapsed",g(n,d)):a="expanded",o=e};s.genes=function(){return o},s.gene_slot=function(){return r[a]},s.height=function(e){return arguments.length?(n=e,s):n},s.scale=function(t){return arguments.length?(e=t,s):e};var l=function(e){for(var n=[],o=e,r=0,a=0;a<e.length;a++)e[a].slot>r&&e[a].slot<t&&(r=e[a].slot);for(var a=0;a<o.length;a++){var s=d(n),l=o[a];if(void 0!==l.slot&&l.slot<t&&i(l,s[l.slot]))n.push(l);else for(var u=0;;){if(i(l,s[u])){l.slot=u,n.push(l),u>r&&(r=u);break}u++}}return r+1},i=function(t,n){if(void 0===n)return!0;for(var o=0;o<n.length;o++){var r=n[o];if(t.ID!==r.ID){var a=8*r.external_name.length+e(r.start),s=e(r.start),l=e(r.end)>a?e(r.end):a,i=8*t.external_name.length+e(t.start),u=e(t.start),c=e(t.end)>i?e(t.end):i;if(s>u&&c>s||u>s&&l>u)return!1}}return!0},u=function(e,t){for(var n=c(t),o=0;o<e.length;o++)void 0!==n[e[o].ID]&&(e[o].slot=n[e[o].ID])},c=function(e){for(var t={},n=0;n<e.length;n++){var o=e[n];t[o.ID]=o.slot}return t},g=function(){},d=function(e){for(var t=[],n=0;n<e.length;n++)void 0===t[e[n].slot]&&(t[e[n].slot]=[]),t[e[n].slot].push(e[n]);return t};return s};