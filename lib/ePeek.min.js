var epeek=function(){"use strict";for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++){var n=d3.select(e[t]).attr("src");if(console.log(n),-1!==n.indexOf("ePeek")){console.log("FOUND!");break}}var o,r,a,s,l,i,c,u,g,_,d,f="human",h=7,p=139424940,m=141784100,v=rest(),k=[],P=300,x=600,b=150,y=d3.rgb("#DDDDDD"),w=d3.rgb("#000000"),D=d3.rgb("#000000"),I=!0,T=d3.ease("cubic-in-out"),A=d3.behavior.zoom(),N=500,O=function(e){d=d3.select(e).attr("id"),O.genes_layout.height(b),d3.select(e).classed("ePeek",!0);var t=d3.select(e),n=t.append("div").attr("class","ePeek_locRow"),o=t.append("div").attr("class","ePeek_groupDiv");i=o.append("svg").attr("class","ePeek_svg").attr("width",x).attr("height",b).style("background-color",y).append("g").attr("transform","translate(0,20)").append("g").attr("class","ePeek_g"),c=i.append("rect").attr("class","ePeek_pane").attr("id","ePeek_"+d+"_pane").attr("width",x).attr("height",b).style("fill",w);var r=i.append("text").attr("class","ePeek_wideOK_text").attr("id","ePeek_"+d+"_tooWide").attr("fill",y).text("Region too wide"),a=r[0][0].getBBox();r.attr("x",~~(x/2-a.width/2)).attr("y",~~(b/2-a.height/2)),n.append("span").text("Current location: "),n.append("span").attr("id","ePeek_"+d+"_species").text(f),n.append("span").text(" ("),n.append("span").attr("id","ePeek_"+d+"_chr").text(h),n.append("span").text(":"),n.append("span").attr("id","ePeek_"+d+"_from").text(p),n.append("span").text("-"),n.append("span").attr("id","ePeek_"+d+"_to").text(m),n.append("span").text(")"),n.append("img").attr("class","ePeek_activity_signal").attr("id","ePeek_"+d+"_activity_signal").attr("src","lib/green_button_small.png")};O.startOnOrigin=function(){void 0!==O.gene()?O.get_gene(O.gene()):O.start()},O.start=function(){v.call({url:v.url("chr_info",{species:f,chr:h}),success:function(e){a=e.length}}),v.call({url:v.url("region",{species:f,chr:h,fromPos:p,toPos:m}),success:function(e){k=e,z(),E()}})};var z=function(){u=d3.scale.linear().domain([p,m]).range([0,x]),O.genes_layout(k,u),g=d3.svg.axis().scale(u).orient("top"),I&&c.call(A.x(u).on("zoom",S))},E=function(){var e=O.genes_layout.genes(),t=i.selectAll(".ePeek_gs").data(e,function(e){return e.ID});t.selectAll(".ePeek_gene").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return O.genes_layout.gene_slot().slot_height*e.slot}).attr("height",O.genes_layout.gene_slot().gene_height),t.selectAll(".ePeek_name").data(e,function(e){return e.ID}).transition().duration(500).attr("y",function(e){return O.genes_layout.gene_slot().slot_height*e.slot+25}).text(function(e){return O.genes_layout.gene_slot().show_label?e.external_name:""}),t.enter().append("g").attr("class","ePeek_gs").call(G),t.exit().remove(),t.on("click",function(e){O.gene_info_callback(e)}),j()},G=function(e){e.append("rect").attr("class","ePeek_gene").attr("x",function(e){return u(e.start)}).attr("y",function(e){return console.log("D.SLOT:"+e.slot),console.log("SLOT_HEIGHT:"+O.genes_layout.gene_slot().slot_height),O.genes_layout.gene_slot().slot_height*e.slot}).attr("width",function(e){return u(e.end)-u(e.start)}).attr("height",O.genes_layout.gene_slot().gene_height).attr("fill",y).transition().duration(N).attr("fill",function(){return w}),e.append("text").attr("class","ePeek_name").attr("x",function(e){return u(e.start)}).attr("y",function(e){return O.genes_layout.gene_slot().slot_height*e.slot+25}).attr("fill",y).text(function(e){return O.genes_layout.gene_slot().show_label?e.external_name:""}).style("font-weight",function(){return"normal"}).transition().duration(N).attr("fill",function(){return w})},j=function(){i.call(g);var e=i.selectAll(".ePeek_gs");e.select(".ePeek_gene").attr("x",function(e){return u(e.start)}).attr("width",function(e){return u(e.end)-u(e.start)}),e.select(".ePeek_name").attr("x",function(e){return u(e.start)});var t=u.domain();d3.select("#ePeek_"+d+"_species").text(f),d3.select("#ePeek_"+d+"_chr").text(h),d3.select("#ePeek_"+d+"_from").text(~~t[0]),d3.select("#ePeek_"+d+"_to").text(~~t[1])},R=function(e,t){var n,o=u.domain(),r=o[1]-o[0],a=r*e-r;switch(t){case-1:n=[~~o[0]-a,~~(o[1]-a)];break;case 1:n=[~~o[0]+a,~~(o[1]-a)];break;case 0:n=[o[0]-~~(a/2),o[1]+~~a/2]}var s=d3.interpolateNumber(o[0],n[0]),l=O.ease(),i=0;d3.timer(function(){var e,n=s(l(i));switch(t){case-1:e=n+r;break;case 1:e=n+r;break;case 0:e=o[1]+o[0]-n}var a=[n,e];return u.domain(a),S(u),i+=.02,i>1})};O.right=function(e){e>0&&R(e,1)},O.left=function(e){e>0&&R(e,-1)},O.zoom=function(e){R(e,0)};var S=function(e){void 0!==e&&I&&A.x(e);var t=u.domain();t[0]<0?(void 0===s&&(s=t[1]),t=[0,s],u.domain(t),I&&A.x(u)):s=void 0,t[1]>a?(void 0===l&&(l=t[0]),u.domain([l,a]),I&&A.x(u)):l=void 0,window.clearTimeout(_),_=window.setTimeout(function(){var e=u.domain();O.from(~~e[0]),O.to(~~e[1]),console.log("New Pos:"+p+"-"+m),d3.select("#ePeek_"+d+"_activity_signal").attr("src","lib/red_button_small.png"),v.call({url:v.url("region",{species:f,chr:h,fromPos:p,toPos:m}),success:function(e){d3.select("#ePeek_"+d+"_activity_signal").attr("src","lib/green_button_small.png"),d3.select("#ePeek_"+d+"_pane").classed("ePeek_dark_pane",!1),d3.select("#ePeek_"+d+"_tooWide").classed("ePeek_tooWide_text",!1),O.genes_layout(e,u),E()},error:function(){console.log("GREEN AGAIN!!!"),d3.select("#ePeek_"+d+"_activity_signal").attr("src","lib/green_button_small.png"),d3.select("#ePeek_"+d+"_pane").classed("ePeek_dark_pane",!0),d3.select("#ePeek_"+d+"_tooWide").classed("ePeek_tooWide_text",!0).moveToFront()}})},300),j()},W=function(e,t){e.select(".ePeek_gene").transition().duration(500).attr("fill",t),e.select(".ePeek_name").transition().duration(500).style("fill",t)};O.unhighlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return W(t,w),O},O.highlight_gene=function(e){var t=d3.selectAll(".ePeek_gs").filter(function(t){return e(t)});return W(t,D),O},O.resize=function(e){d3.select(".ePeek_svg").attr("width",e),d3.select("#ePeek_"+d+"_pane").attr("width",e),O.width(e),z(),j()},O.get_gene=function(e){v.call({url:v.url("species_gene",{species:f,gene_name:e}),success:function(e){e=e.filter(function(e){return!e.id.indexOf("ENS")}),void 0!==e[0]?(B(e[0].id),O.ensGenes_callback(e),O.ensGene_lookup(e[0].id)):O.start()}})},O.homologues=function(e){v.call({url:v.url("homologues",{gene_name:e}),success:function(e){var t=e.data[0].homologies;O.homologues_callback(t)}})},O.ensGene_lookup=function(e){O.homologues(e),v.call({url:v.url("gene",{gene_name:e}),success:function(e){O.species(e.species).chr(e.seq_region_name).from(e.start).to(e.end),O.start()}})};var B=function(e){return arguments.length?(r=e,O):r};return O.species=function(e){return arguments.length?(f=e,O):f},O.chr=function(e){return arguments.length?(h=e,O):h},O.from=function(e){return arguments.length?(p=e,O):p},O.to=function(e){return arguments.length?(m=e,O):m},O.gene=function(e){return arguments.length?(o=e,O):o},O.height=function(e){return arguments.length?(b=e,O):b},O.width=function(e){return arguments.length?(P>e&&(e=P),x=e,O):x},O.background_color=function(e){return arguments.length?(y=d3.rgb(e),O):y},O.foreground_color=function(e){return arguments.length?(w=d3.rgb(e),O):w},O.highlight_color=function(e){return arguments.length?(D=d3.rgb(e),O):D},O.ease=function(e){return arguments.length?(T=d3.ease(e),O):T},O.allow_drag=function(e){return arguments.length?(I=e,I?void 0!==u&&(c.call(A.x(u).on("zoom",S)),A.x(u).on("zoom",S)):A.x(d3.scale.linear()).on("zoom",null),O):I},O.split_homologues=function(e){var t=/ortholog/,n=/paralog/,o=e.filter(function(e){return e.type.match(t)}),r=e.filter(function(e){return e.type.match(n)});return{orthologues:o,paralogues:r}},O.genes_layout=epeek_genes(),O.gene_info_callback=function(){},O.ensGenes_callback=function(){},O.homologues_callback=function(){},O};d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var rest=function(){var e="http://beta.rest.ensembl.org",t=e+"/feature/region/",n=e+"/lookup/",o=e+"/xrefs/symbol/",r=e+"/homology/id/",a=e+"/assembly/info/",s=function(){};return s.localREST=function(){return e="http://127.0.0.1:3000",t=e+"/feature/region/",n=e+"/lookup/id/",o=e+"/xrefs/symbol/",r=e+"/homology/id/",s},s.call=function(e){var t=e.url,n=e.success,o=e.error;console.log("URL:"+t),d3.json(t,function(e,t){console.log("RESP:"),console.log(t),void 0!==t&&null===e&&n(t),null!==e&&o()})},s.url=function(e,s){return"region"===e?t+s.species+"/"+s.chr+":"+s.fromPos+"-"+s.toPos+".json?feature=gene":"species_gene"===e?o+s.species+"/"+s.gene_name+".json?object_type=gene":"homologues"===e?r+s.gene_name+".json?format=condensed;sequence=none;type=all":"gene"===e?n+s.gene_name+".json?format=full":"chr_info"===e?a+s.species+"/"+s.chr:void 0},s},epeek_genes=function(){"use strict";var e,t,n=150,o=[],r={expanded:{slot_height:30,gene_height:10,show_label:!0},collapsed:{slot_height:5,gene_height:3,show_label:!1}},a="expanded",s=function(e,i){for(var u=0;u<e.length;u++)null===e[u].external_name&&(e[u].external_name="");t=~~(n/r.expanded.slot_height)-1,void 0!==i&&s.scale(i),c(e,o);var _=l(e);_>t?(a="collapsed",g(n,_)):a="expanded",o=e};s.genes=function(){return o},s.gene_slot=function(){return r[a]},s.height=function(e){return arguments.length?(n=e,s):n},s.scale=function(t){return arguments.length?(e=t,s):e};var l=function(e){for(var n=[],o=e,r=0,a=0;a<e.length;a++)e[a].slot>r&&e[a].slot<t&&(r=e[a].slot);for(var a=0;a<o.length;a++){var s=_(n),l=o[a];if(void 0!==l.slot&&l.slot<t&&i(l,s[l.slot]))n.push(l);else for(var c=0;;){if(i(l,s[c])){l.slot=c,n.push(l),c>r&&(r=c);break}c++}}return r+1},i=function(t,n){if(void 0===n)return!0;for(var o=0;o<n.length;o++){var r=n[o];if(t.ID!==r.ID){var a=8*r.external_name.length+e(r.start),s=e(r.start),l=e(r.end)>a?e(r.end):a,i=8*t.external_name.length+e(t.start),c=e(t.start),u=e(t.end)>i?e(t.end):i;if(s>c&&u>s||c>s&&l>c)return!1}}return!0},c=function(e,t){for(var n=u(t),o=0;o<e.length;o++)void 0!==n[e[o].ID]&&(e[o].slot=n[e[o].ID])},u=function(e){for(var t={},n=0;n<e.length;n++){var o=e[n];t[o.ID]=o.slot}return t},g=function(){},_=function(e){for(var t=[],n=0;n<e.length;n++)void 0===t[e[n].slot]&&(t[e[n].slot]=[]),t[e[n].slot].push(e[n]);return t};return s};