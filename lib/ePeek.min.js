var epeek=function(){"use strict";var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){var src=d3.select(scripts[i]).attr("src");console.log(src);if(src.indexOf("ePeek")!==-1){console.log("FOUND!");break}}var gene;var ensGene;var species="human";var chr=7;var fromPos=139424940;var toPos=141784100;var chr_length;var eRest=rest();var genes=[];var min_width=300;var width=600;var height=150;var bgColor=d3.rgb("#DDDDDD");var fgColor=d3.rgb("#000000");var highlightColor=d3.rgb("#000000");var drag_allowed=true;var curr_ease=d3.ease("cubic-in-out");var fivePrimeEdge;var threePrimeEdge;var svg_g;var pane;var xScale;var zoomEventHandler=d3.behavior.zoom();var xAxis;var refresh;var dur=500;var div_id;var gBrowser=function(div){div_id=d3.select(div).attr("id");gBrowser.genes_layout.height(height);d3.select(div).classed("ePeek",true);var browserDiv=d3.select(div);var locRow=browserDiv.append("div").attr("class","ePeek_locRow");var groupDiv=browserDiv.append("div").attr("class","ePeek_groupDiv");svg_g=groupDiv.append("svg").attr("class","ePeek_svg").attr("width",width).attr("height",height).style("background-color",bgColor).append("g").attr("transform","translate(0,20)").append("g").attr("class","ePeek_g");pane=svg_g.append("rect").attr("class","ePeek_pane").attr("id","ePeek_"+div_id+"_pane").attr("width",width).attr("height",height).style("fill",fgColor);var tooWide_text=svg_g.append("text").attr("class","ePeek_wideOK_text").attr("id","ePeek_"+div_id+"_tooWide").attr("fill",bgColor).text("Region too wide");var bb=tooWide_text[0][0].getBBox();tooWide_text.attr("x",~~(width/2-bb.width/2)).attr("y",~~(height/2-bb.height/2));locRow.append("span").text("Current location: ");locRow.append("span").attr("id","ePeek_"+div_id+"_species").text(species);locRow.append("span").text(" (");locRow.append("span").attr("id","ePeek_"+div_id+"_chr").text(chr);locRow.append("span").text(":");locRow.append("span").attr("id","ePeek_"+div_id+"_from").text(fromPos);locRow.append("span").text("-");locRow.append("span").attr("id","ePeek_"+div_id+"_to").text(toPos);locRow.append("span").text(")");locRow.append("img").attr("class","ePeek_activity_signal").attr("id","ePeek_"+div_id+"_activity_signal").attr("src","lib/green_button_small.png")};gBrowser.startOnOrigin=function(){if(gBrowser.gene()!==undefined){gBrowser.get_gene(gBrowser.gene())}else{gBrowser.start()}return};gBrowser.start=function(){eRest.call({url:eRest.url("chr_info",{species:species,chr:chr}),success:function(resp){chr_length=resp.length}});eRest.call({url:eRest.url("region",{species:species,chr:chr,fromPos:fromPos,toPos:toPos}),success:function(resp){genes=resp;plot();update_layout()}})};var plot=function(){xScale=d3.scale.linear().domain([fromPos,toPos]).range([0,width]);gBrowser.genes_layout(genes,xScale);xAxis=d3.svg.axis().scale(xScale).orient("top");if(drag_allowed){pane.call(zoomEventHandler.x(xScale).on("zoom",zoom))}};var update_layout=function(){var newdata=gBrowser.genes_layout.genes();var g_genes=svg_g.selectAll(".ePeek_gs").data(newdata,function(d){return d.ID});g_genes.selectAll(".ePeek_gene").data(newdata,function(d){return d.ID}).transition().duration(500).attr("y",function(d){return gBrowser.genes_layout.gene_slot().slot_height*d.slot}).attr("height",gBrowser.genes_layout.gene_slot().gene_height);g_genes.selectAll(".ePeek_name").data(newdata,function(d){return d.ID}).transition().duration(500).attr("y",function(d){return gBrowser.genes_layout.gene_slot().slot_height*d.slot+25}).text(function(d){if(gBrowser.genes_layout.gene_slot().show_label){return d.external_name}else{return""}});g_genes.enter().append("g").attr("class","ePeek_gs").call(plot_gene);g_genes.exit().remove();g_genes.on("click",function(d){gBrowser.gene_info_callback(d)});update()};var plot_gene=function(new_gene){new_gene.append("rect").attr("class","ePeek_gene").attr("x",function(d){return xScale(d.start)}).attr("y",function(d){console.log("D.SLOT:"+d.slot);console.log("SLOT_HEIGHT:"+gBrowser.genes_layout.gene_slot().slot_height);return gBrowser.genes_layout.gene_slot().slot_height*d.slot}).attr("width",function(d){return xScale(d.end)-xScale(d.start)}).attr("height",gBrowser.genes_layout.gene_slot().gene_height).attr("fill",bgColor).transition().duration(dur).attr("fill",function(d){return fgColor});new_gene.append("text").attr("class","ePeek_name").attr("x",function(d){return xScale(d.start)}).attr("y",function(d){return gBrowser.genes_layout.gene_slot().slot_height*d.slot+25}).attr("fill",bgColor).text(function(d){if(gBrowser.genes_layout.gene_slot().show_label){return d.external_name}else{return""}}).style("font-weight",function(d){return"normal"}).transition().duration(dur).attr("fill",function(d){return fgColor})};var update=function(){svg_g.call(xAxis);var g_genes=svg_g.selectAll(".ePeek_gs");g_genes.select(".ePeek_gene").attr("x",function(d){return xScale(d.start)}).attr("width",function(d){return xScale(d.end)-xScale(d.start)});g_genes.select(".ePeek_name").attr("x",function(d){return xScale(d.start)});var xScale_domain=xScale.domain();d3.select("#ePeek_"+div_id+"_species").text(species);d3.select("#ePeek_"+div_id+"_chr").text(chr);d3.select("#ePeek_"+div_id+"_from").text(~~xScale_domain[0]);d3.select("#ePeek_"+div_id+"_to").text(~~xScale_domain[1])};var move=function(factor,direction){var oldDomain=xScale.domain();var span=oldDomain[1]-oldDomain[0];var offset=span*factor-span;var newDomain;switch(direction){case-1:newDomain=[~~oldDomain[0]-offset,~~(oldDomain[1]-offset)];break;case 1:newDomain=[~~oldDomain[0]+offset,~~(oldDomain[1]-offset)];break;case 0:newDomain=[oldDomain[0]-~~(offset/2),oldDomain[1]+~~offset/2]}var interpolator=d3.interpolateNumber(oldDomain[0],newDomain[0]);var ease=gBrowser.ease();var x=0;d3.timer(function(d){var curr_start=interpolator(ease(x));var curr_end;switch(direction){case-1:curr_end=curr_start+span;break;case 1:curr_end=curr_start+span;break;case 0:curr_end=oldDomain[1]+oldDomain[0]-curr_start;break}var currDomain=[curr_start,curr_end];xScale.domain(currDomain);zoom(xScale);x+=.02;return x>1})};gBrowser.right=function(factor){if(factor>0){move(factor,1)}};gBrowser.left=function(factor){if(factor>0){move(factor,-1)}};gBrowser.zoom=function(factor){move(factor,0)};var zoom=function(new_xScale){if(new_xScale!==undefined&&drag_allowed){zoomEventHandler.x(new_xScale)}var currDomain=xScale.domain();if(currDomain[0]<0){if(fivePrimeEdge===undefined){fivePrimeEdge=currDomain[1]}currDomain=[0,fivePrimeEdge];xScale.domain(currDomain);if(drag_allowed){zoomEventHandler.x(xScale)}}else{fivePrimeEdge=undefined}if(currDomain[1]>chr_length){if(threePrimeEdge===undefined){threePrimeEdge=currDomain[0]}xScale.domain([threePrimeEdge,chr_length]);if(drag_allowed){zoomEventHandler.x(xScale)}}else{threePrimeEdge=undefined}window.clearTimeout(refresh);refresh=window.setTimeout(function(){var currDomain=xScale.domain();gBrowser.from(~~currDomain[0]);gBrowser.to(~~currDomain[1]);console.log("New Pos:"+fromPos+"-"+toPos);d3.select("#ePeek_"+div_id+"_activity_signal").attr("src","lib/red_button_small.png");eRest.call({url:eRest.url("region",{species:species,chr:chr,fromPos:fromPos,toPos:toPos}),success:function(resp){d3.select("#ePeek_"+div_id+"_activity_signal").attr("src","lib/green_button_small.png");d3.select("#ePeek_"+div_id+"_pane").classed("ePeek_dark_pane",false);d3.select("#ePeek_"+div_id+"_tooWide").classed("ePeek_tooWide_text",false);gBrowser.genes_layout(resp,xScale);update_layout()},error:function(){console.log("GREEN AGAIN!!!");d3.select("#ePeek_"+div_id+"_activity_signal").attr("src","lib/green_button_small.png");d3.select("#ePeek_"+div_id+"_pane").classed("ePeek_dark_pane",true);d3.select("#ePeek_"+div_id+"_tooWide").classed("ePeek_tooWide_text",true).moveToFront()}})},300);update()};var change_gene_color=function(genes,color){genes.select(".ePeek_gene").transition().duration(500).attr("fill",color);genes.select(".ePeek_name").transition().duration(500).style("fill",color)};gBrowser.unhighlight_gene=function(cbak){var genes_to_unhighlight=d3.selectAll(".ePeek_gs").filter(function(d){return cbak(d)});change_gene_color(genes_to_unhighlight,fgColor);return gBrowser};gBrowser.highlight_gene=function(cbak){var genes_to_highlight=d3.selectAll(".ePeek_gs").filter(function(d){return cbak(d)});change_gene_color(genes_to_highlight,highlightColor);return gBrowser};gBrowser.resize=function(w){d3.select(".ePeek_svg").attr("width",w);d3.select("#ePeek_"+div_id+"_pane").attr("width",w);gBrowser.width(w);plot();update()};gBrowser.get_gene=function(gene_name){eRest.call({url:eRest.url("species_gene",{species:species,gene_name:gene_name}),success:function(resp){resp=resp.filter(function(d){return!d.id.indexOf("ENS")});if(resp[0]!==undefined){set_ensGene(resp[0].id);gBrowser.ensGenes_callback(resp);gBrowser.ensGene_lookup(resp[0].id)}else{gBrowser.start()}}})};gBrowser.homologues=function(ensGene){eRest.call({url:eRest.url("homologues",{gene_name:ensGene}),success:function(resp){var homologues=resp.data[0].homologies;gBrowser.homologues_callback(homologues)}})};gBrowser.ensGene_lookup=function(gene_name){gBrowser.homologues(gene_name);eRest.call({url:eRest.url("gene",{gene_name:gene_name}),success:function(resp){gBrowser.species(resp.species).chr(resp.seq_region_name).from(resp.start).to(resp.end);gBrowser.start()}})};var set_ensGene=function(ens){if(!arguments.length){return ensGene}ensGene=ens;return gBrowser};gBrowser.species=function(sp){if(!arguments.length){return species}species=sp;return gBrowser};gBrowser.chr=function(c){if(!arguments.length){return chr}chr=c;return gBrowser};gBrowser.from=function(n){if(!arguments.length){return fromPos}fromPos=n;return gBrowser};gBrowser.to=function(n){if(!arguments.length){return toPos}toPos=n;return gBrowser};gBrowser.gene=function(g){if(!arguments.length){return gene}gene=g;return gBrowser};gBrowser.height=function(h){if(!arguments.length){return height}height=h;return gBrowser};gBrowser.width=function(w){if(!arguments.length){return width}if(w<min_width){w=min_width}width=w;return gBrowser};gBrowser.background_color=function(hex){if(!arguments.length){return bgColor}bgColor=d3.rgb(hex);return gBrowser};gBrowser.foreground_color=function(hex){if(!arguments.length){return fgColor}fgColor=d3.rgb(hex);return gBrowser};gBrowser.highlight_color=function(hex){if(!arguments.length){return highlightColor}highlightColor=d3.rgb(hex);return gBrowser};gBrowser.ease=function(e){if(!arguments.length){return curr_ease}curr_ease=d3.ease(e);return gBrowser};gBrowser.allow_drag=function(b){if(!arguments.length){return drag_allowed}drag_allowed=b;if(drag_allowed){if(xScale!==undefined){pane.call(zoomEventHandler.x(xScale).on("zoom",zoom));zoomEventHandler.x(xScale).on("zoom",zoom)}}else{zoomEventHandler.x(d3.scale.linear()).on("zoom",null)}return gBrowser};gBrowser.split_homologues=function(homologues){var orthoPatt=/ortholog/;var paraPatt=/paralog/;var orthologues=homologues.filter(function(d){return d.type.match(orthoPatt)});var paralogues=homologues.filter(function(d){return d.type.match(paraPatt)});return{orthologues:orthologues,paralogues:paralogues}};gBrowser.genes_layout=epeek_genes();gBrowser.gene_info_callback=function(){};gBrowser.ensGenes_callback=function(){};gBrowser.homologues_callback=function(){};return gBrowser};d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var rest=function(){var prefix="http://beta.rest.ensembl.org";var prefix_region=prefix+"/feature/region/";var prefix_ensgene=prefix+"/lookup/";var prefix_gene=prefix+"/xrefs/symbol/";var prefix_homologues=prefix+"/homology/id/";var prefix_chr_info=prefix+"/assembly/info/";var eRest=function(){};eRest.localREST=function(){prefix="http://127.0.0.1:3000";prefix_region=prefix+"/feature/region/";prefix_ensgene=prefix+"/lookup/id/";prefix_gene=prefix+"/xrefs/symbol/";prefix_homologues=prefix+"/homology/id/";return eRest};eRest.call=function(obj){var url=obj.url;var on_success=obj.success;var on_error=obj.error;console.log("URL:"+url);d3.json(url,function(error,resp){console.log("RESP:");console.log(resp);if(resp!==undefined&&error===null){on_success(resp)}if(error!==null){on_error()}})};eRest.url=function(key,obj){if(key==="region"){return prefix_region+obj.species+"/"+obj.chr+":"+obj.fromPos+"-"+obj.toPos+".json?feature=gene"}if(key==="species_gene"){return prefix_gene+obj.species+"/"+obj.gene_name+".json?object_type=gene"}if(key==="homologues"){return prefix_homologues+obj.gene_name+".json?format=condensed;sequence=none;type=all"}if(key==="gene"){return prefix_ensgene+obj.gene_name+".json?format=full"}if(key==="chr_info"){return prefix_chr_info+obj.species+"/"+obj.chr}};return eRest};var epeek_genes=function(){"use strict";var height=150;var genes=[];var xScale;var max_slots;var slot_types={expanded:{slot_height:30,gene_height:10,show_label:true},collapsed:{slot_height:5,gene_height:3,show_label:false}};var current_slot_type="expanded";var genes_layout=function(new_genes,scale){for(var i=0;i<new_genes.length;i++){if(new_genes[i].external_name===null){new_genes[i].external_name=""}}max_slots=~~(height/slot_types.expanded.slot_height)-1;if(scale!==undefined){genes_layout.scale(scale)}slot_keeper(new_genes,genes);var needed_slots=collition_detector(new_genes);if(needed_slots>max_slots){current_slot_type="collapsed";shrink_slots(height,needed_slots)}else{current_slot_type="expanded"}genes=new_genes};genes_layout.genes=function(){return genes};genes_layout.gene_slot=function(){return slot_types[current_slot_type]};genes_layout.height=function(h){if(!arguments.length){return height}height=h;return genes_layout};genes_layout.scale=function(x){if(!arguments.length){return xScale}xScale=x;return genes_layout};var collition_detector=function(genes){var genes_placed=[];var genes_to_place=genes;var needed_slots=0;for(var i=0;i<genes.length;i++){if(genes[i].slot>needed_slots&&genes[i].slot<max_slots){needed_slots=genes[i].slot}}for(var i=0;i<genes_to_place.length;i++){var genes_by_slot=sort_genes_by_slot(genes_placed);var this_gene=genes_to_place[i];if(this_gene.slot!==undefined&&this_gene.slot<max_slots){if(slot_has_space(this_gene,genes_by_slot[this_gene.slot])){genes_placed.push(this_gene);continue}}var slot=0;OUTER:while(true){if(slot_has_space(this_gene,genes_by_slot[slot])){this_gene.slot=slot;genes_placed.push(this_gene);if(slot>needed_slots){needed_slots=slot}break}slot++}}return needed_slots+1};var slot_has_space=function(query_gene,genes_in_this_slot){if(genes_in_this_slot===undefined){return true}for(var j=0;j<genes_in_this_slot.length;j++){var subj_gene=genes_in_this_slot[j];if(query_gene.ID===subj_gene.ID){continue}var y_label_end=subj_gene.external_name.length*8+xScale(subj_gene.start);var y1=xScale(subj_gene.start);var y2=xScale(subj_gene.end)>y_label_end?xScale(subj_gene.end):y_label_end;var x_label_end=query_gene.external_name.length*8+xScale(query_gene.start);var x1=xScale(query_gene.start);var x2=xScale(query_gene.end)>x_label_end?xScale(query_gene.end):x_label_end;if(x1<y1&&x2>y1||x1>y1&&x1<y2){return false}}return true};var slot_keeper=function(genes,prev_genes){var prev_genes_slots=genes2slots(prev_genes);for(var i=0;i<genes.length;i++){if(prev_genes_slots[genes[i].ID]!==undefined){genes[i].slot=prev_genes_slots[genes[i].ID]}}};var genes2slots=function(genes_array){var hash={};for(var i=0;i<genes_array.length;i++){var gene=genes_array[i];hash[gene.ID]=gene.slot}return hash};var shrink_slots=function(height,needed_slots){return};var sort_genes_by_slot=function(genes){var slots=[];for(var i=0;i<genes.length;i++){if(slots[genes[i].slot]===undefined){slots[genes[i].slot]=[]}slots[genes[i].slot].push(genes[i])}return slots};return genes_layout};